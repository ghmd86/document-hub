{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "extractionStrategy": [
    {
      "id": "getAccountArrangements",
      "description": "Get account arrangements, only active arrangement will be returned unless expand option is selected.",
      "endpoint": {
        "url": "https://devapi.vda.dv01.c1busw2.aws/private/creditcard/accounts/${$input.accountId}/arrangements",
        "method": "GET",
        "headers": {
          "x-correlation-Id": "${x-correlation-Id}",
          "apikey": "${API_KEY}",
          "Accept": "application/json"
        },
        "timeout": 5000,
        "retryPolicy": {
          "maxAttempts": 3,
          "backoffStrategy": "exponential",
          "initialDelayMs": 100,
          "maxDelayMs": 2000,
          "retryOn": [500, 502, 503, 504, 408]
        }
      },
      "cache": {
        "enabled": true,
        "ttl": 1800,
        "keyPattern": "arrangements:${$input.accountId}",
        "invalidateOn": ["ACCOUNT_UPDATED"]
      },
      "responseMapping": {
        "extract": {
          "pricingId": "$.content[?(@.domain == 'PRICING' && @.status == 'ACTIVE')].domainId | [0]",
          "allPricingIds": "$.content[?(@.domain == 'PRICING')].domainId",
          "arrangementStatus": "$.content[?(@.domain == 'PRICING')].status | [0]"
        },
        "transform": {
          "pricingId": {
            "type": "selectFirst",
            "fallback": null
          }
        },
        "validate": {
          "pricingId": {
            "type": "string",
            "required": true,
            "pattern": "^[A-Z0-9_-]+$",
            "errorMessage": "No active pricing arrangement found for account"
          }
        }
      },
      "errorHandling": {
        "onValidationError": {
          "action": "fail",
          "returnDefault": {
            "disclosureCode": "DEFAULT_DISCLOSURE"
          }
        },
        "on404": {
          "action": "fail",
          "message": "Account arrangements not found"
        },
        "on5xx": {
          "action": "retry"
        }
      },
      "nextCalls": [
        {
          "condition": {
            "field": "pricingId",
            "operator": "notNull"
          },
          "dependsOn": "pricingId",
          "targetDataSource": "getPricingData"
        }
      ]
    },
    {
      "id": "getPricingData",
      "description": "Returns pricing data for a given pricing id",
      "endpoint": {
        "url": "https://devapi.vda.dv01.c1busw2.aws/private/enterprise/product-management-system/pricing-management-service/prices/${pricingId}",
        "method": "GET",
        "headers": {
          "x-correlation-Id": "${x-correlation-Id}",
          "apikey": "${API_KEY}",
          "Accept": "application/json"
        },
        "timeout": 5000,
        "retryPolicy": {
          "maxAttempts": 3,
          "backoffStrategy": "exponential",
          "initialDelayMs": 100,
          "maxDelayMs": 2000,
          "retryOn": [500, 502, 503, 504, 408]
        }
      },
      "cache": {
        "enabled": true,
        "ttl": 3600,
        "keyPattern": "pricing:${pricingId}",
        "invalidateOn": ["PRICING_UPDATED"]
      },
      "responseMapping": {
        "extract": {
          "disclosureCode": "$.cardholderAgreementsTncCode",
          "pricingVersion": "$.version",
          "effectiveDate": "$.effectiveDate",
          "expirationDate": "$.expirationDate"
        },
        "validate": {
          "disclosureCode": {
            "type": "string",
            "required": true,
            "pattern": "^DISC_[A-Z0-9_]+$",
            "errorMessage": "Invalid or missing disclosure code in pricing data"
          },
          "effectiveDate": {
            "type": "date",
            "validateInPast": true
          },
          "expirationDate": {
            "type": "date",
            "validateInFuture": true
          }
        }
      },
      "errorHandling": {
        "onValidationError": {
          "action": "log-and-fail",
          "severity": "ERROR"
        },
        "on404": {
          "action": "fail",
          "message": "Pricing data not found for pricingId: ${pricingId}"
        }
      },
      "storeAs": "disclosureData",
      "returnFields": ["disclosureCode", "pricingVersion", "effectiveDate"]
    }
  ],
  "executionRules": {
    "startFrom": "getAccountArrangements",
    "executionMode": "sequential",
    "stopOnError": true,
    "errorHandling": {
      "strategy": "fail-fast",
      "defaultResponse": {
        "disclosureCode": "DEFAULT_DISCLOSURE",
        "source": "fallback",
        "reason": "${error.message}"
      }
    },
    "monitoring": {
      "logLevel": "INFO",
      "trackMetrics": true,
      "metrics": {
        "latency": true,
        "cacheHitRate": true,
        "errorRate": true,
        "extractionSuccess": true
      },
      "alerting": {
        "slowRequestThresholdMs": 3000,
        "errorRateThreshold": 0.05
      }
    },
    "circuitBreaker": {
      "enabled": true,
      "failureThreshold": 5,
      "resetTimeoutMs": 60000,
      "halfOpenRequests": 3
    }
  },
  "outputSchema": {
    "disclosureCode": "${disclosureData.disclosureCode}",
    "metadata": {
      "pricingId": "${getAccountArrangements.pricingId}",
      "pricingVersion": "${disclosureData.pricingVersion}",
      "effectiveDate": "${disclosureData.effectiveDate}",
      "executionTime": "${context.executionTime}",
      "cacheHits": "${context.cacheHits}",
      "traceId": "${x-correlation-Id}"
    }
  }
}
