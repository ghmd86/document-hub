{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "version": "1.0.0",
  "dataSources": [
    {
      "id": "customerInfo",
      "description": "Fetch customer details from CRM API",
      "endpoint": {
        "url": "https://api.crm.com/customers",
        "method": "GET",
        "headers": {
          "Authorization": "Bearer ${authToken}"
        },
        "queryParams": {
          "customerId": "${input.customerId}"
        },
        "timeout": 5000,
        "retryPolicy": {
          "maxAttempts": 3,
          "backoffStrategy": "exponential",
          "retryOn": [500, 502, 503, 504]
        }
      },
      "cache": {
        "enabled": true,
        "ttl": 3600,
        "keyPattern": "customer:${input.customerId}"
      },
      "responseMapping": {
        "extract": {
          "customerName": "$.data.name",
          "accountId": "$.data.account.id",
          "accountType": "$.data.account.type",
          "state": "$.data.address.state"
        },
        "transform": {
          "state": "uppercase"
        },
        "validate": {
          "schema": {
            "accountId": { "type": "string", "required": true },
            "accountType": { "type": "string", "enum": ["CHECKING", "SAVINGS", "CREDIT_CARD"] }
          }
        }
      },
      "conditionalNext": [
        {
          "condition": {
            "field": "accountType",
            "operator": "equals",
            "value": "CREDIT_CARD"
          },
          "targetDataSource": "creditCardDetails"
        },
        {
          "condition": {
            "field": "accountType",
            "operator": "in",
            "value": ["CHECKING", "SAVINGS"]
          },
          "targetDataSource": "bankAccountDetails"
        }
      ]
    },
    {
      "id": "creditCardDetails",
      "description": "Fetch credit card specific details",
      "endpoint": {
        "url": "https://api.bank.com/creditcards/${accountId}",
        "method": "GET",
        "headers": {
          "Authorization": "Bearer ${authToken}"
        }
      },
      "responseMapping": {
        "extract": {
          "creditLimit": "$.data.creditLimit",
          "apr": "$.data.apr"
        }
      },
      "storeAs": "accountDetailsOutput"
    }
  ],

  "documentSelectionEngine": {
    "type": "decision-table",
    "inputMapping": {
      "accountType": "${customerInfo.accountType}",
      "state": "${customerInfo.state}",
      "balance": "${accountDetailsOutput.balance}",
      "creditLimit": "${accountDetailsOutput.creditLimit}"
    },
    "decisionTable": [
      {
        "priority": 1,
        "conditions": {
          "all": [
            { "field": "accountType", "operator": "equals", "value": "CREDIT_CARD" },
            { "field": "state", "operator": "in", "value": ["CA", "NY", "TX"] }
          ]
        },
        "output": {
          "documentId": "CC_AGREEMENT_REGULATED_STATES",
          "disclosureCode": "DISC_CC_REG_001",
          "documentVersion": "2.1"
        }
      },
      {
        "priority": 2,
        "conditions": {
          "all": [
            { "field": "accountType", "operator": "equals", "value": "CREDIT_CARD" }
          ]
        },
        "output": {
          "documentId": "CC_AGREEMENT_STANDARD",
          "disclosureCode": "DISC_CC_STD_001",
          "documentVersion": "2.0"
        }
      },
      {
        "priority": 3,
        "conditions": {
          "all": [
            { "field": "accountType", "operator": "equals", "value": "CHECKING" },
            { "field": "balance", "operator": "greaterThan", "value": 10000 }
          ]
        },
        "output": {
          "documentId": "CHECKING_PREMIUM_AGREEMENT",
          "disclosureCode": "DISC_CHK_PREM_001",
          "documentVersion": "1.5"
        }
      }
    ],
    "defaultOutput": {
      "documentId": "STANDARD_AGREEMENT",
      "disclosureCode": "DISC_DEFAULT",
      "documentVersion": "1.0"
    }
  },

  "executionRules": {
    "startFrom": "customerInfo",
    "executionMode": "sequential",
    "errorHandling": {
      "strategy": "fail-fast",
      "onError": [
        {
          "errorType": "NETWORK_ERROR",
          "action": "retry"
        },
        {
          "errorType": "VALIDATION_ERROR",
          "action": "return-default"
        }
      ]
    },
    "logLevel": "INFO",
    "metrics": {
      "enabled": true,
      "trackLatency": true,
      "trackCacheHitRate": true
    }
  },

  "outputSchema": {
    "documentId": "${documentSelectionEngine.output.documentId}",
    "disclosureCode": "${documentSelectionEngine.output.disclosureCode}",
    "documentVersion": "${documentSelectionEngine.output.documentVersion}",
    "customerName": "${customerInfo.customerName}",
    "accountId": "${customerInfo.accountId}",
    "metadata": {
      "executionTime": "${context.executionTime}",
      "cacheHit": "${context.cacheHit}"
    }
  }
}
